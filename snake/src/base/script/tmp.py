from contextlib import redirect_stdout
from datetime import datetime, timedelta
import collections
from io import StringIO

import psycopg2
from openpyxl import Workbook
from pandas._libs.internals import defaultdict


# 连接到PostgreSQL数据库
def get_data_from_pgsql():
    conn = psycopg2.connect(
        host="172.18.37.248",
        port="5432",
        database="elss",
        user="postgres",
        password="postgres"
    )

    query = """
            SELECT ps.name,
                   string_agg('"' || to_char(start_time, 'YYYY-MM-DD HH24:MI') || '~' ||
                              to_char(
                                      CASE
                                          WHEN psp.period_type = 'PERIOD_TYPE_K' THEN
                                              CASE
                                                  WHEN ps.station_type IN (0, 1, 2) THEN
                                                      date_trunc('day', end_time) + interval '20 hours'
                                                  WHEN ps.station_type = 3 THEN
                                                      date_trunc('day', end_time) + interval '18 hours'
                                                  ELSE end_time
                                                  END
                                          ELSE end_time
                                          END, 'YYYY-MM-DD HH24:MI') || '"', ',' ORDER BY start_time)
            FROM power_station_agc_k_filing_period psp
                     LEFT JOIN power_station ps ON psp.station_id = ps.station_id
            WHERE date(start_time) BETWEEN '2025-01-01' AND '2025-04-24'
              AND ps.name IN
                  (
                   '绿谷峡通风电',
                   '海翔如海风电',
                   '盛东如海风电',
                   '国信如海风电',
                   '和风如海风电',
                   '中电二洪风电',
                   '国华东台风电',
                   '国信黄海风电',
                   '毛竹沙风电',
                   '双创台海风电',
                   '东尚墩尚光伏',
                   '华能灌云风电',
                   '华电墩尚光伏',
                   '东尚赣榆光伏',
                   '沿海灌云光伏'
                      )
            GROUP BY ps.name; \
            """

    cursor = conn.cursor()
    cursor.execute(query)
    results = cursor.fetchall()
    cursor.close()
    conn.close()

    return results


# 定义季节
def get_season(month):
    if 3 <= month <= 5:
        return "春季"
    elif 6 <= month <= 8:
        return "夏季"
    elif 9 <= month <= 11:
        return "秋季"
    else:
        return "冬季"  # 12月及1-2月


def analyze_time_periods(time_periods):
    result: str = ''

    # 初始化统计字典
    season_hours = defaultdict(float)
    month_hours = defaultdict(float)
    hour_hours = defaultdict(float)

    # 处理每个时间段
    for period in time_periods:
        start_str, end_str = period.strip().split("~")
        start = datetime.strptime(start_str.strip(), "%Y-%m-%d %H:%M")
        end = datetime.strptime(end_str.strip(), "%Y-%m-%d %H:%M")

        current = start
        while current < end:
            # 计算当前小时结束时间
            hour_end = (current + timedelta(hours=1)).replace(minute=0, second=0)
            chunk_end = min(hour_end, end)

            # 计算当前小时内的持续时间（精确到分钟）
            duration = (chunk_end - current).total_seconds() / 3600

            # 统计季节和月份（根据实际发生时间）
            season = get_season(current.month)
            season_hours[season] += duration
            month_hours[current.month] += duration

            # 统计小时段（如12点指12:00-13:00）
            hour_hours[current.hour] += duration

            current = chunk_end  # 移动到下一个小时

    # 生成统计结果
    def get_max(data_dict):
        max_key = max(data_dict, key=lambda k: data_dict[k])
        return max_key, data_dict[max_key]

    # 输出详细统计
    print("季节统计（小时）:")
    for season, hours in sorted(season_hours.items(), key=lambda x: x):
        print(f"{season}: {hours:.2f}h")

    print("\n月份统计（小时）:")
    for month, hours in sorted(month_hours.items(), key=lambda x: x):
        print(f"{month}月: {hours:.2f}h")

    print("\n小时段统计（小时）:")
    for hour, hours in sorted(hour_hours.items(), key=lambda x: x):
        print(f"{hour:02d}:00-{hour + 1:02d}:00: {hours:.2f}h")

    # 获取最大值
    max_season, season_h = get_max(season_hours)
    max_month, month_h = get_max(month_hours)
    max_hour, hour_h = get_max(hour_hours)

    print(f"\n分析结果：")
    print(f"弃电最严重季节：{max_season}（{season_h:.2f}小时）")
    print(f"弃电最严重月份：{max_month}月（{month_h:.2f}小时）")
    print(f"弃电最严重时段：{max_hour:02d}:00-{max_hour + 1:02d}:00（{hour_h:.2f}小时）")

    return result


def main():
    # 从数据库获取数据
    # db_results = get_data_from_pgsql()
    db_results = [('盛东如海风电',
                   '"2025-01-09 13:14~2025-01-09 13:34","2025-01-22 11:26~2025-01-22 14:41","2025-01-27 08:47~2025-01-27 11:06","2025-01-27 11:41~2025-01-27 16:15","2025-01-28 09:31~2025-01-28 09:43","2025-01-28 09:50~2025-01-28 10:16","2025-01-28 11:50~2025-01-28 13:58","2025-01-28 15:05~2025-01-28 15:12","2025-01-29 09:02~2025-01-29 16:10","2025-01-30 08:19~2025-01-30 14:44","2025-01-30 15:01~2025-01-30 15:37","2025-01-30 15:46~2025-01-30 16:14","2025-01-30 16:16~2025-01-30 16:24","2025-02-16 11:37~2025-02-16 15:54","2025-02-19 11:50~2025-02-19 14:06","2025-03-06 10:57~2025-03-06 15:24","2025-03-16 10:30~2025-03-16 13:14","2025-03-16 13:19~2025-03-16 15:29","2025-03-16 15:34~2025-03-16 16:13","2025-03-18 09:14~2025-03-18 10:27","2025-03-18 10:42~2025-03-18 11:57","2025-03-18 12:02~2025-03-18 13:42","2025-03-18 15:02~2025-03-18 15:51","2025-03-19 09:32~2025-03-19 14:41","2025-03-20 09:46~2025-03-20 15:49","2025-03-21 09:08~2025-03-21 15:24","2025-03-22 09:07~2025-03-22 10:07","2025-03-22 11:55~2025-03-22 12:58","2025-03-22 13:25~2025-03-22 14:21","2025-03-22 14:59~2025-03-22 15:25","2025-03-24 08:47~2025-03-24 09:48","2025-03-24 11:16~2025-03-24 12:41","2025-03-26 11:04~2025-03-26 12:17","2025-04-01 08:48~2025-04-01 15:45","2025-04-02 11:19~2025-04-02 15:29","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-20 07:55~2025-04-20 15:55","2025-04-22 08:45~2025-04-22 15:12"'),
                  ('东尚墩尚光伏',
                   '"2025-01-27 08:01~2025-01-27 18:00","2025-01-28 08:00~2025-01-28 18:00","2025-01-29 08:30~2025-01-29 18:00","2025-01-30 08:00~2025-01-30 18:00","2025-02-03 08:45~2025-02-03 18:00","2025-02-04 11:00~2025-02-04 18:00","2025-03-06 06:00~2025-03-06 18:00","2025-03-08 06:00~2025-03-08 18:00","2025-03-09 06:00~2025-03-09 18:00","2025-03-10 06:00~2025-03-10 18:00","2025-03-14 06:00~2025-03-14 18:00","2025-03-16 06:00~2025-03-16 18:00","2025-03-17 06:00~2025-03-17 18:00","2025-03-18 06:00~2025-03-18 18:00","2025-03-19 06:00~2025-03-19 18:00","2025-03-20 06:00~2025-03-20 18:00","2025-03-21 06:00~2025-03-21 18:00","2025-03-22 06:00~2025-03-22 18:00","2025-03-23 06:00~2025-03-23 18:00","2025-03-24 06:00~2025-03-24 18:00","2025-03-25 06:00~2025-03-25 18:00","2025-03-26 06:00~2025-03-26 18:00","2025-03-27 06:00~2025-03-27 18:00","2025-03-30 06:00~2025-03-30 18:00","2025-03-31 06:00~2025-03-31 18:00","2025-04-01 08:48~2025-04-01 10:43","2025-04-01 10:57~2025-04-01 13:43","2025-04-01 13:48~2025-04-01 14:42","2025-04-02 11:19~2025-04-02 15:29","2025-04-03 10:36~2025-04-03 10:59","2025-04-03 11:40~2025-04-03 13:05","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-06 06:00~2025-04-06 18:00","2025-04-07 07:52~2025-04-07 14:44","2025-04-08 09:05~2025-04-08 15:10","2025-04-10 06:00~2025-04-10 18:00","2025-04-11 09:50~2025-04-11 13:40","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 07:20~2025-04-16 17:25","2025-04-17 08:45~2025-04-17 14:35","2025-04-18 08:45~2025-04-18 14:20","2025-04-19 09:39~2025-04-19 15:03","2025-04-20 07:55~2025-04-20 15:55","2025-04-21 09:45~2025-04-21 11:05","2025-04-22 08:45~2025-04-22 15:12","2025-04-23 09:44~2025-04-23 14:24","2025-04-24 08:27~2025-04-24 14:54"'),
                  ('东尚赣榆光伏',
                   '"2025-01-27 08:01~2025-01-27 18:00","2025-01-28 08:00~2025-01-28 18:00","2025-01-29 08:30~2025-01-29 18:00","2025-01-30 08:00~2025-01-30 18:00","2025-02-03 08:45~2025-02-03 18:00","2025-02-04 11:00~2025-02-04 18:00","2025-03-06 06:00~2025-03-06 18:00","2025-03-08 06:00~2025-03-08 18:00","2025-03-09 06:00~2025-03-09 18:00","2025-03-10 06:00~2025-03-10 18:00","2025-03-14 06:00~2025-03-14 18:00","2025-03-16 06:00~2025-03-16 18:00","2025-03-17 06:00~2025-03-17 18:00","2025-03-18 06:00~2025-03-18 18:00","2025-03-19 06:00~2025-03-19 18:00","2025-03-20 06:00~2025-03-20 18:00","2025-03-21 06:00~2025-03-21 18:00","2025-03-22 06:00~2025-03-22 18:00","2025-03-23 06:00~2025-03-23 18:00","2025-03-24 06:00~2025-03-24 18:00","2025-03-25 06:00~2025-03-25 18:00","2025-03-26 06:00~2025-03-26 18:00","2025-03-27 06:00~2025-03-27 18:00","2025-03-30 06:00~2025-03-30 18:00","2025-03-31 06:00~2025-03-31 18:00","2025-04-01 08:48~2025-04-01 10:28","2025-04-01 10:57~2025-04-01 13:58","2025-04-02 11:19~2025-04-02 15:29","2025-04-03 11:40~2025-04-03 11:49","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-06 06:00~2025-04-06 18:00","2025-04-07 07:52~2025-04-07 14:44","2025-04-08 09:05~2025-04-08 15:10","2025-04-10 06:00~2025-04-10 18:00","2025-04-11 09:50~2025-04-11 13:40","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 06:00~2025-04-16 18:00","2025-04-17 08:45~2025-04-17 14:35","2025-04-18 08:45~2025-04-18 14:20","2025-04-19 09:39~2025-04-19 15:03","2025-04-20 07:55~2025-04-20 15:55","2025-04-21 09:45~2025-04-21 11:05","2025-04-22 08:45~2025-04-22 15:12","2025-04-23 09:44~2025-04-23 14:24","2025-04-24 08:27~2025-04-24 14:54"'),
                  ('国华东台风电',
                   '"2025-01-09 11:26~2025-01-09 12:40","2025-01-15 09:41~2025-01-15 14:39","2025-01-22 10:31~2025-01-22 11:51","2025-01-22 12:01~2025-01-22 13:27","2025-01-27 07:56~2025-01-27 16:27","2025-01-28 08:00~2025-01-28 20:00","2025-01-29 08:30~2025-01-29 20:00","2025-01-30 08:00~2025-01-30 20:00","2025-02-01 03:09~2025-02-01 04:45","2025-02-01 05:39~2025-02-01 06:14","2025-02-01 06:39~2025-02-01 08:03","2025-02-03 08:45~2025-02-03 20:00","2025-02-04 11:00~2025-02-04 20:00","2025-02-05 10:59~2025-02-05 15:47","2025-02-07 08:48~2025-02-07 10:12","2025-02-07 10:18~2025-02-07 10:56","2025-02-07 10:57~2025-02-07 11:54","2025-02-07 12:03~2025-02-07 13:20","2025-02-07 13:33~2025-02-07 14:39","2025-02-07 14:48~2025-02-07 15:31","2025-02-07 15:33~2025-02-07 16:01","2025-02-08 12:58~2025-02-08 13:13","2025-02-08 13:23~2025-02-08 14:32","2025-02-11 09:29~2025-02-11 12:44","2025-02-16 11:37~2025-02-16 15:54","2025-02-19 11:58~2025-02-19 13:20","2025-02-19 13:24~2025-02-19 13:57","2025-03-06 09:22~2025-03-06 15:35","2025-03-09 08:42~2025-03-09 14:44","2025-03-14 04:00~2025-03-14 20:00","2025-03-16 08:24~2025-03-16 12:06","2025-03-16 14:43~2025-03-16 15:37","2025-03-16 16:09~2025-03-16 16:21","2025-03-16 16:24~2025-03-16 16:27","2025-03-17 09:36~2025-03-17 12:58","2025-03-18 08:30~2025-03-18 11:09","2025-03-18 11:24~2025-03-18 11:45","2025-03-18 12:15~2025-03-18 12:36","2025-03-19 09:32~2025-03-19 14:41","2025-03-20 04:00~2025-03-20 20:00","2025-03-21 04:00~2025-03-21 20:00","2025-03-22 07:56~2025-03-22 16:23","2025-03-23 07:57~2025-03-23 13:24","2025-03-24 04:00~2025-03-24 20:00","2025-03-25 04:00~2025-03-25 20:00","2025-03-26 04:00~2025-03-26 20:00","2025-03-27 10:51~2025-03-27 11:12","2025-03-27 15:48~2025-03-27 16:07","2025-03-30 04:00~2025-03-30 20:00","2025-03-31 04:00~2025-03-31 20:00","2025-04-01 14:09~2025-04-01 14:54","2025-04-02 11:19~2025-04-02 15:29","2025-04-03 10:05~2025-04-03 14:06","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-06 06:00~2025-04-06 20:00","2025-04-07 06:00~2025-04-07 20:00","2025-04-08 06:05~2025-04-08 15:10","2025-04-10 06:00~2025-04-10 20:00","2025-04-11 09:50~2025-04-11 13:40","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 07:20~2025-04-16 17:25","2025-04-17 06:00~2025-04-17 20:00","2025-04-18 08:45~2025-04-18 14:20","2025-04-19 09:39~2025-04-19 15:03","2025-04-20 07:55~2025-04-20 15:55","2025-04-21 06:00~2025-04-21 20:00","2025-04-22 08:45~2025-04-22 15:12","2025-04-23 06:00~2025-04-23 20:00","2025-04-24 08:27~2025-04-24 14:54"'),
                  ('国信黄海风电',
                   '"2025-01-09 11:24~2025-01-09 14:09","2025-01-15 11:31~2025-01-15 12:40","2025-01-22 11:18~2025-01-22 14:58","2025-01-22 15:02~2025-01-22 15:42","2025-01-27 08:18~2025-01-27 11:09","2025-01-27 11:12~2025-01-27 15:37","2025-01-28 09:15~2025-01-28 11:10","2025-01-28 11:24~2025-01-28 14:49","2025-01-30 09:30~2025-01-30 13:17","2025-02-03 12:04~2025-02-03 12:49","2025-02-19 14:05~2025-02-19 15:13","2025-03-06 10:55~2025-03-06 14:05","2025-03-09 10:55~2025-03-09 11:07","2025-03-09 11:29~2025-03-09 13:27","2025-03-16 09:39~2025-03-16 13:49","2025-03-16 14:42~2025-03-16 15:49","2025-03-17 10:09~2025-03-17 13:14","2025-03-18 09:33~2025-03-18 10:53","2025-03-18 11:26~2025-03-18 11:44","2025-03-19 04:00~2025-03-19 20:00","2025-03-20 04:00~2025-03-20 20:00","2025-03-21 11:52~2025-03-21 12:15","2025-03-21 13:22~2025-03-21 15:15","2025-03-22 04:00~2025-03-22 20:00","2025-03-23 04:00~2025-03-23 20:00","2025-03-24 04:00~2025-03-24 20:00","2025-03-25 04:00~2025-03-25 20:00","2025-03-26 04:00~2025-03-26 20:00","2025-03-27 11:09~2025-03-27 13:18","2025-03-30 04:00~2025-03-30 20:00","2025-03-31 04:00~2025-03-31 20:00","2025-04-01 10:02~2025-04-01 11:22","2025-04-01 11:32~2025-04-01 13:10","2025-04-02 11:19~2025-04-02 15:29","2025-04-03 06:00~2025-04-03 20:00","2025-04-04 06:00~2025-04-04 20:00","2025-04-05 08:12~2025-04-05 15:51","2025-04-06 06:00~2025-04-06 20:00","2025-04-07 06:00~2025-04-07 20:00","2025-04-08 06:00~2025-04-08 20:00","2025-04-10 06:00~2025-04-10 20:00","2025-04-11 06:00~2025-04-11 20:00","2025-04-12 06:00~2025-04-12 20:00","2025-04-13 06:00~2025-04-13 20:00","2025-04-14 06:00~2025-04-14 20:00","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 06:00~2025-04-16 20:00","2025-04-17 06:00~2025-04-17 20:00","2025-04-18 08:45~2025-04-18 14:20","2025-04-19 09:39~2025-04-19 15:03","2025-04-20 07:55~2025-04-20 15:55","2025-04-21 06:00~2025-04-21 20:00","2025-04-22 06:00~2025-04-22 20:00","2025-04-23 06:00~2025-04-23 20:00","2025-04-24 06:00~2025-04-24 20:00"'),
                  ('国信如海风电',
                   '"2025-01-22 11:17~2025-01-22 15:30","2025-01-27 08:56~2025-01-27 12:06","2025-01-27 12:23~2025-01-27 16:27","2025-01-28 09:35~2025-01-28 11:00","2025-01-28 12:37~2025-01-28 15:12","2025-01-29 09:02~2025-01-29 16:10","2025-01-30 08:35~2025-01-30 15:56","2025-02-16 11:37~2025-02-16 15:54","2025-02-19 12:03~2025-02-19 14:07","2025-03-06 11:15~2025-03-06 14:09","2025-03-09 08:42~2025-03-09 14:44","2025-03-16 14:19~2025-03-16 16:42","2025-03-18 08:32~2025-03-18 16:11","2025-03-20 10:54~2025-03-20 11:06","2025-03-21 08:46~2025-03-21 10:07","2025-03-21 10:16~2025-03-21 15:54","2025-03-22 08:42~2025-03-22 14:00","2025-03-24 12:01~2025-03-24 12:59","2025-04-02 11:19~2025-04-02 15:29","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-20 07:55~2025-04-20 15:55","2025-04-22 08:45~2025-04-22 15:12"'),
                  ('海翔如海风电',
                   '"2025-01-22 13:25~2025-01-22 15:13","2025-01-27 08:02~2025-01-27 16:24","2025-01-28 09:01~2025-01-28 10:15","2025-01-28 11:35~2025-01-28 13:00","2025-01-28 13:05~2025-01-28 14:30","2025-01-29 09:02~2025-01-29 16:10","2025-01-30 08:31~2025-01-30 16:43","2025-02-03 12:29~2025-02-03 13:53","2025-02-05 11:29~2025-02-05 13:25","2025-02-07 08:46~2025-02-07 16:16","2025-02-16 11:37~2025-02-16 15:54","2025-02-19 12:03~2025-02-19 14:06","2025-03-02 20:10~2025-03-02 20:38","2025-03-06 15:01~2025-03-06 15:35","2025-03-16 09:12~2025-03-16 10:44","2025-03-16 10:57~2025-03-16 13:29","2025-03-18 08:39~2025-03-18 09:57","2025-03-18 15:17~2025-03-18 16:08","2025-03-19 09:32~2025-03-19 14:41","2025-03-20 11:32~2025-03-20 15:41","2025-03-21 10:01~2025-03-21 15:28","2025-03-22 08:42~2025-03-22 13:15","2025-03-22 13:40~2025-03-22 15:00","2025-03-24 10:57~2025-03-24 12:56","2025-04-02 11:19~2025-04-02 15:29","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 07:20~2025-04-16 17:25","2025-04-20 07:55~2025-04-20 15:55","2025-04-22 08:45~2025-04-22 15:12"'),
                  ('和风如海风电',
                   '"2025-01-22 10:31~2025-01-22 11:56","2025-01-22 13:01~2025-01-22 14:41","2025-01-27 08:02~2025-01-27 09:21","2025-01-27 09:26~2025-01-27 16:20","2025-01-28 09:31~2025-01-28 11:04","2025-01-28 12:13~2025-01-28 13:27","2025-01-29 09:02~2025-01-29 16:10","2025-01-30 08:19~2025-01-30 16:35","2025-02-03 12:58~2025-02-03 13:22","2025-02-07 11:02~2025-02-07 12:27","2025-03-02 20:03~2025-03-02 20:25","2025-03-06 15:16~2025-03-06 15:28","2025-03-09 08:42~2025-03-09 14:44","2025-03-16 09:12~2025-03-16 10:59","2025-03-16 11:11~2025-03-16 12:59","2025-03-18 08:58~2025-03-18 10:12","2025-03-19 09:32~2025-03-19 14:41","2025-03-20 11:22~2025-03-20 15:31","2025-03-21 09:30~2025-03-21 15:29","2025-03-22 09:07~2025-03-22 13:09","2025-03-22 15:10~2025-03-22 15:44","2025-03-24 10:31~2025-03-24 12:11","2025-03-25 11:25~2025-03-25 12:35","2025-04-02 11:19~2025-04-02 15:29","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-20 07:55~2025-04-20 15:55","2025-04-22 08:45~2025-04-22 15:12"'),
                  ('华电墩尚光伏',
                   '"2025-01-09 10:03~2025-01-09 15:02","2025-01-15 09:40~2025-01-15 11:53","2025-01-15 13:57~2025-01-15 14:32","2025-01-22 12:24~2025-01-22 14:14","2025-01-27 08:01~2025-01-27 18:00","2025-01-28 08:00~2025-01-28 18:00","2025-01-29 08:30~2025-01-29 18:00","2025-01-30 08:00~2025-01-30 18:00","2025-02-03 08:45~2025-02-03 18:00","2025-02-04 11:00~2025-02-04 18:00","2025-02-05 11:19~2025-02-05 13:30","2025-02-05 13:35~2025-02-05 15:47","2025-02-07 09:11~2025-02-07 14:57","2025-02-08 10:12~2025-02-08 14:54","2025-02-11 09:28~2025-02-11 12:42","2025-02-16 11:36~2025-02-16 14:21","2025-02-16 14:23~2025-02-16 15:43","2025-02-19 15:02~2025-02-19 15:24","2025-02-24 11:55~2025-02-24 13:03","2025-02-24 13:31~2025-02-24 14:06","2025-02-25 12:45~2025-02-25 14:49","2025-02-28 11:52~2025-02-28 12:20","2025-03-06 09:37~2025-03-06 15:15","2025-03-08 11:09~2025-03-08 14:00","2025-03-09 08:42~2025-03-09 14:44","2025-03-10 12:44~2025-03-10 14:21","2025-03-14 11:00~2025-03-14 12:53","2025-03-16 08:28~2025-03-16 16:26","2025-03-16 08:41~2025-03-16 16:25","2025-03-17 08:54~2025-03-17 15:57","2025-03-17 14:54~2025-03-17 15:55","2025-03-18 09:31~2025-03-18 15:06","2025-03-19 09:36~2025-03-19 10:37","2025-03-19 10:41~2025-03-19 11:11","2025-03-19 11:47~2025-03-19 14:35","2025-03-19 11:50~2025-03-19 13:27","2025-03-20 11:07~2025-03-20 13:10","2025-03-21 06:00~2025-03-21 18:00","2025-03-22 11:26~2025-03-22 15:58","2025-03-23 07:57~2025-03-23 13:05","2025-03-24 09:18~2025-03-24 15:00","2025-03-24 09:24~2025-03-24 13:28","2025-03-24 09:48~2025-03-24 12:58","2025-03-25 08:13~2025-03-25 14:09","2025-03-26 08:01~2025-03-26 11:12","2025-03-26 11:13~2025-03-26 12:15","2025-03-27 08:58~2025-03-27 15:32","2025-03-30 06:00~2025-03-30 18:00","2025-03-31 09:26~2025-03-31 11:01","2025-03-31 11:36~2025-03-31 12:15","2025-03-31 14:32~2025-03-31 14:43","2025-04-01 10:33~2025-04-01 13:19","2025-04-02 11:19~2025-04-02 15:29","2025-04-03 12:55~2025-04-03 14:02","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-06 06:00~2025-04-06 18:00","2025-04-07 07:52~2025-04-07 14:44","2025-04-08 09:05~2025-04-08 15:10","2025-04-10 11:55~2025-04-10 15:05","2025-04-11 09:50~2025-04-11 13:40","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 07:20~2025-04-16 17:25","2025-04-17 08:45~2025-04-17 14:35","2025-04-18 08:45~2025-04-18 14:20","2025-04-19 09:39~2025-04-19 15:03","2025-04-20 07:55~2025-04-20 15:55","2025-04-21 09:45~2025-04-21 11:05","2025-04-22 08:45~2025-04-22 15:12","2025-04-23 09:44~2025-04-23 14:24","2025-04-24 08:27~2025-04-24 14:54"'),
                  ('华能灌云风电',
                   '"2025-01-05 13:30~2025-01-05 14:16","2025-01-09 11:07~2025-01-09 14:55","2025-01-15 09:40~2025-01-15 11:43","2025-01-22 11:20~2025-01-22 12:41","2025-01-22 12:50~2025-01-22 14:07","2025-01-27 08:32~2025-01-27 10:18","2025-01-27 11:58~2025-01-27 14:19","2025-01-28 08:50~2025-01-28 13:55","2025-01-28 14:20~2025-01-28 15:19","2025-01-29 15:29~2025-01-29 15:59","2025-01-30 14:51~2025-01-30 16:08","2025-02-03 09:15~2025-02-03 16:01","2025-02-05 12:20~2025-02-05 14:58","2025-02-07 09:19~2025-02-07 10:44","2025-02-07 10:49~2025-02-07 12:46","2025-02-07 14:04~2025-02-07 14:57","2025-02-08 10:12~2025-02-08 10:26","2025-02-08 10:31~2025-02-08 13:14","2025-02-08 13:42~2025-02-08 14:28","2025-02-11 09:31~2025-02-11 09:47","2025-02-11 10:00~2025-02-11 12:39","2025-02-16 11:36~2025-02-16 14:23","2025-02-19 11:32~2025-02-19 15:22","2025-02-25 12:45~2025-02-25 14:46","2025-03-06 09:22~2025-03-06 15:35","2025-03-09 08:42~2025-03-09 14:44","2025-03-14 09:40~2025-03-14 10:15","2025-03-14 11:12~2025-03-14 12:24","2025-03-16 08:23~2025-03-16 16:28","2025-03-17 08:54~2025-03-17 13:13","2025-03-17 13:14~2025-03-17 15:49","2025-03-18 08:02~2025-03-18 09:25","2025-03-19 11:47~2025-03-19 14:30","2025-03-20 11:07~2025-03-20 13:12","2025-03-21 08:34~2025-03-21 14:06","2025-03-22 11:26~2025-03-22 13:13","2025-03-22 13:26~2025-03-22 15:28","2025-03-23 07:57~2025-03-23 12:03","2025-03-23 12:12~2025-03-23 13:00","2025-03-24 08:03~2025-03-24 09:28","2025-03-24 09:33~2025-03-24 10:08","2025-03-24 10:12~2025-03-24 11:11","2025-03-24 11:18~2025-03-24 13:13","2025-03-24 13:18~2025-03-24 14:50","2025-03-25 08:13~2025-03-25 09:52","2025-03-25 09:56~2025-03-25 13:40","2025-03-26 08:01~2025-03-26 11:07","2025-03-26 11:13~2025-03-26 12:10","2025-03-27 08:58~2025-03-27 10:23","2025-03-27 10:25~2025-03-27 15:33","2025-03-31 09:26~2025-03-31 10:42","2025-04-01 10:20~2025-04-01 13:05","2025-04-01 13:40~2025-04-01 14:40","2025-04-02 11:19~2025-04-02 15:29","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-07 07:52~2025-04-07 14:44","2025-04-08 09:05~2025-04-08 15:10","2025-04-10 11:55~2025-04-10 15:05","2025-04-11 09:50~2025-04-11 13:40","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 07:20~2025-04-16 17:25","2025-04-17 08:45~2025-04-17 14:35","2025-04-18 08:45~2025-04-18 14:20","2025-04-19 09:39~2025-04-19 15:03","2025-04-20 07:55~2025-04-20 15:55","2025-04-21 09:45~2025-04-21 11:05","2025-04-22 08:45~2025-04-22 15:12","2025-04-23 09:44~2025-04-23 14:24","2025-04-24 08:27~2025-04-24 14:54"'),
                  ('绿谷峡通风电',
                   '"2025-01-22 10:54~2025-01-22 15:22","2025-01-27 07:56~2025-01-27 16:27","2025-01-28 08:20~2025-01-28 09:44","2025-01-28 09:50~2025-01-28 11:45","2025-01-28 11:48~2025-01-28 15:28","2025-01-29 09:02~2025-01-29 16:10","2025-01-30 08:02~2025-01-30 16:54","2025-02-01 03:05~2025-02-01 04:30","2025-02-01 04:35~2025-02-01 06:00","2025-02-01 06:41~2025-02-01 08:00","2025-02-03 09:28~2025-02-03 10:21","2025-02-03 11:24~2025-02-03 12:36","2025-02-03 12:48~2025-02-03 14:06","2025-02-03 14:13~2025-02-03 14:26","2025-02-05 11:29~2025-02-05 13:23","2025-02-07 09:20~2025-02-07 10:42","2025-02-07 10:47~2025-02-07 12:57","2025-02-07 14:17~2025-02-07 15:47","2025-02-08 11:55~2025-02-08 13:20","2025-02-28 11:39~2025-02-28 12:40","2025-03-06 10:31~2025-03-06 15:35","2025-03-09 08:42~2025-03-09 14:44","2025-03-16 08:46~2025-03-16 09:59","2025-03-16 10:32~2025-03-16 16:23","2025-03-17 04:00~2025-03-17 20:00","2025-03-18 09:27~2025-03-18 12:12","2025-03-18 12:17~2025-03-18 15:42","2025-03-19 09:32~2025-03-19 14:41","2025-03-20 11:48~2025-03-20 13:14","2025-03-20 13:22~2025-03-20 15:38","2025-03-21 11:31~2025-03-21 15:29","2025-03-22 04:00~2025-03-22 20:00","2025-03-23 04:00~2025-03-23 20:00","2025-03-24 04:00~2025-03-24 20:00","2025-03-25 04:00~2025-03-25 20:00","2025-03-26 04:00~2025-03-26 20:00","2025-03-27 04:00~2025-03-27 20:00","2025-03-30 04:00~2025-03-30 20:00","2025-03-31 04:00~2025-03-31 20:00","2025-04-01 06:00~2025-04-01 20:00","2025-04-02 11:19~2025-04-02 15:29","2025-04-03 06:00~2025-04-03 20:00","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-06 06:00~2025-04-06 20:00","2025-04-07 06:00~2025-04-07 20:00","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 07:20~2025-04-16 17:25","2025-04-20 07:55~2025-04-20 15:55","2025-04-22 08:45~2025-04-22 15:12"'),
                  ('毛竹沙风电',
                   '"2025-01-15 09:49~2025-01-15 11:54","2025-01-15 12:31~2025-01-15 13:19","2025-01-22 12:11~2025-01-22 15:28","2025-01-27 09:13~2025-01-27 09:30","2025-01-27 09:48~2025-01-27 09:54","2025-01-28 08:58~2025-01-28 10:44","2025-01-28 10:49~2025-01-28 12:14","2025-01-28 12:19~2025-01-28 15:26","2025-01-30 09:17~2025-01-30 09:54","2025-01-30 15:50~2025-01-30 16:49","2025-02-03 12:29~2025-02-03 13:24","2025-02-03 13:26~2025-02-03 13:52","2025-02-07 10:03~2025-02-07 13:40","2025-02-07 13:48~2025-02-07 15:26","2025-02-19 13:44~2025-02-19 14:59","2025-03-06 10:40~2025-03-06 14:57","2025-03-16 09:46~2025-03-16 16:34","2025-03-17 08:52~2025-03-17 16:08","2025-03-18 08:51~2025-03-18 10:23","2025-03-18 10:30~2025-03-18 14:08","2025-03-18 15:00~2025-03-18 15:49","2025-03-19 09:32~2025-03-19 14:41","2025-03-20 11:37~2025-03-20 11:56","2025-03-20 12:45~2025-03-20 14:33","2025-03-21 10:37~2025-03-21 11:59","2025-03-22 09:25~2025-03-22 10:49","2025-03-22 11:27~2025-03-22 13:34","2025-03-22 13:40~2025-03-22 15:04","2025-03-23 10:37~2025-03-23 11:47","2025-03-25 11:28~2025-03-25 12:09","2025-03-31 08:59~2025-03-31 14:45","2025-04-02 11:19~2025-04-02 15:29","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-08 09:05~2025-04-08 15:10","2025-04-11 09:50~2025-04-11 13:40","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 07:20~2025-04-16 17:25","2025-04-18 08:45~2025-04-18 14:20","2025-04-19 09:39~2025-04-19 15:03","2025-04-20 07:55~2025-04-20 15:55","2025-04-22 08:45~2025-04-22 15:12","2025-04-24 08:27~2025-04-24 14:54"'),
                  ('双创台海风电',
                   '"2025-01-15 09:46~2025-01-15 11:41","2025-01-22 12:11~2025-01-22 15:08","2025-01-27 08:49~2025-01-27 14:50","2025-01-27 14:52~2025-01-27 16:02","2025-01-28 12:49~2025-01-28 14:23","2025-01-28 14:34~2025-01-28 15:06","2025-01-30 09:33~2025-01-30 13:23","2025-03-02 19:50~2025-03-02 20:53","2025-03-06 10:56~2025-03-06 14:57","2025-03-16 09:13~2025-03-16 10:32","2025-03-16 10:54~2025-03-16 16:26","2025-03-17 08:52~2025-03-17 16:08","2025-03-18 09:25~2025-03-18 10:38","2025-03-18 11:05~2025-03-18 13:39","2025-03-18 13:45~2025-03-18 15:08","2025-03-19 09:32~2025-03-19 14:41","2025-03-20 04:00~2025-03-20 20:00","2025-03-21 11:22~2025-03-21 12:55","2025-03-22 07:56~2025-03-22 16:23","2025-03-23 04:00~2025-03-23 20:00","2025-03-24 04:00~2025-03-24 20:00","2025-03-25 04:00~2025-03-25 20:00","2025-03-26 04:00~2025-03-26 20:00","2025-03-27 08:59~2025-03-27 15:33","2025-03-30 04:00~2025-03-30 20:00","2025-03-31 04:00~2025-03-31 20:00","2025-04-01 06:00~2025-04-01 20:00","2025-04-02 06:00~2025-04-02 20:00","2025-04-03 06:00~2025-04-03 20:00","2025-04-04 06:00~2025-04-04 20:00","2025-04-05 08:12~2025-04-05 15:51","2025-04-06 06:00~2025-04-06 20:00","2025-04-07 06:00~2025-04-07 20:00","2025-04-08 09:05~2025-04-08 15:10","2025-04-10 06:00~2025-04-10 20:00","2025-04-11 09:50~2025-04-11 13:40","2025-04-12 06:00~2025-04-12 20:00","2025-04-13 06:00~2025-04-13 20:00","2025-04-14 06:00~2025-04-14 20:00","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 06:00~2025-04-16 20:00","2025-04-17 06:00~2025-04-17 20:00","2025-04-18 08:45~2025-04-18 14:20","2025-04-19 09:39~2025-04-19 15:03","2025-04-20 07:55~2025-04-20 15:55","2025-04-21 06:00~2025-04-21 20:00","2025-04-22 08:45~2025-04-22 15:12","2025-04-23 06:00~2025-04-23 20:00","2025-04-24 08:27~2025-04-24 14:54"'),
                  ('沿海灌云光伏',
                   '"2025-01-09 10:04~2025-01-09 11:01","2025-01-09 11:48~2025-01-09 15:01","2025-01-15 09:40~2025-01-15 11:51","2025-01-15 13:57~2025-01-15 14:30","2025-01-22 12:35~2025-01-22 14:11","2025-01-27 08:50~2025-01-27 10:23","2025-01-27 12:21~2025-01-27 14:21","2025-01-28 10:05~2025-01-28 14:13","2025-01-29 10:01~2025-01-29 11:13","2025-01-30 09:46~2025-01-30 12:30","2025-02-03 12:09~2025-02-03 13:31","2025-02-03 13:39~2025-02-03 14:34","2025-02-05 14:05~2025-02-05 15:45","2025-02-08 11:27~2025-02-08 13:36","2025-02-08 13:52~2025-02-08 14:53","2025-02-11 11:05~2025-02-11 12:42","2025-02-16 14:16~2025-02-16 15:41","2025-02-19 11:30~2025-02-19 15:24","2025-02-25 13:27~2025-02-25 14:47","2025-03-23 09:12~2025-03-23 12:01","2025-03-24 09:33~2025-03-24 13:10","2025-03-24 13:33~2025-03-24 14:58","2025-03-26 09:31~2025-03-26 11:12","2025-03-27 10:28~2025-03-27 15:27","2025-03-31 10:03~2025-03-31 11:01","2025-03-31 11:36~2025-03-31 12:15","2025-04-02 11:19~2025-04-02 15:29","2025-04-03 13:00~2025-04-03 14:02","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-07 07:52~2025-04-07 14:44","2025-04-08 09:05~2025-04-08 15:10","2025-04-10 11:55~2025-04-10 15:05","2025-04-11 09:50~2025-04-11 13:40","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 07:20~2025-04-16 17:25","2025-04-17 08:45~2025-04-17 14:35","2025-04-18 08:45~2025-04-18 14:20","2025-04-19 09:39~2025-04-19 15:03","2025-04-20 07:55~2025-04-20 15:55","2025-04-21 09:45~2025-04-21 11:05","2025-04-22 08:45~2025-04-22 15:12"'),
                  ('中电二洪风电',
                   '"2025-01-09 11:24~2025-01-09 14:17","2025-01-15 10:23~2025-01-15 12:42","2025-01-22 10:32~2025-01-22 15:47","2025-01-27 07:57~2025-01-27 15:45","2025-01-28 08:20~2025-01-28 14:52","2025-01-28 15:27~2025-01-28 15:43","2025-01-29 09:02~2025-01-29 16:10","2025-01-30 09:04~2025-01-30 13:17","2025-01-30 14:53~2025-01-30 16:14","2025-02-01 03:52~2025-02-01 05:17","2025-02-01 06:40~2025-02-01 07:22","2025-02-03 09:29~2025-02-03 09:52","2025-02-03 10:49~2025-02-03 12:28","2025-02-03 12:34~2025-02-03 13:06","2025-02-05 10:59~2025-02-05 15:47","2025-02-07 09:12~2025-02-07 09:42","2025-02-07 09:44~2025-02-07 11:39","2025-02-07 11:59~2025-02-07 13:25","2025-02-11 11:04~2025-02-11 11:46","2025-02-11 11:54~2025-02-11 12:01","2025-02-16 13:59~2025-02-16 14:18","2025-02-16 14:21~2025-02-16 14:47","2025-02-16 15:00~2025-02-16 15:54","2025-02-19 11:35~2025-02-19 15:09","2025-03-06 09:22~2025-03-06 15:35","2025-03-09 08:42~2025-03-09 14:44","2025-03-10 12:46~2025-03-10 13:13","2025-03-14 11:14~2025-03-14 11:32","2025-03-16 14:39~2025-03-16 15:59","2025-03-17 08:54~2025-03-17 13:13","2025-03-17 13:24~2025-03-17 14:44","2025-03-18 08:31~2025-03-18 11:46","2025-03-18 12:01~2025-03-18 13:03","2025-03-20 11:31~2025-03-20 14:07","2025-03-20 14:16~2025-03-20 14:29","2025-03-21 09:07~2025-03-21 13:42","2025-03-21 15:22~2025-03-21 15:41","2025-03-22 07:55~2025-03-22 11:20","2025-03-22 11:25~2025-03-22 13:14","2025-03-22 13:25~2025-03-22 15:46","2025-03-23 07:57~2025-03-23 12:19","2025-03-24 08:02~2025-03-24 09:50","2025-03-24 10:02~2025-03-24 10:38","2025-03-24 12:02~2025-03-24 12:07","2025-03-24 12:17~2025-03-24 12:51","2025-03-24 13:02~2025-03-24 13:35","2025-03-24 13:47~2025-03-24 14:10","2025-03-25 07:53~2025-03-25 08:17","2025-03-25 08:19~2025-03-25 11:12","2025-03-25 11:19~2025-03-25 12:52","2025-03-25 13:04~2025-03-25 13:36","2025-03-26 08:02~2025-03-26 09:43","2025-03-27 09:44~2025-03-27 10:54","2025-03-27 10:59~2025-03-27 11:09","2025-03-27 11:12~2025-03-27 13:18","2025-03-27 14:39~2025-03-27 14:50","2025-03-31 08:59~2025-03-31 14:45","2025-04-01 10:17~2025-04-01 11:51","2025-04-01 12:17~2025-04-01 13:12","2025-04-01 13:32~2025-04-01 14:42","2025-04-01 15:17~2025-04-01 15:36","2025-04-02 11:19~2025-04-02 15:29","2025-04-03 10:05~2025-04-03 14:06","2025-04-04 07:29~2025-04-04 13:57","2025-04-05 08:12~2025-04-05 15:51","2025-04-06 08:02~2025-04-06 09:17","2025-04-07 07:52~2025-04-07 14:44","2025-04-08 09:05~2025-04-08 15:10","2025-04-10 11:55~2025-04-10 15:05","2025-04-11 09:50~2025-04-11 13:40","2025-04-12 11:45~2025-04-12 17:25","2025-04-13 07:05~2025-04-13 17:00","2025-04-14 07:45~2025-04-14 16:10","2025-04-15 07:25~2025-04-15 15:55","2025-04-16 07:20~2025-04-16 17:25","2025-04-18 08:45~2025-04-18 14:20","2025-04-19 09:39~2025-04-19 15:03","2025-04-20 07:55~2025-04-20 15:55","2025-04-21 09:45~2025-04-21 11:05","2025-04-22 08:45~2025-04-22 15:12","2025-04-24 08:27~2025-04-24 14:54"')]

    # 创建Excel工作簿
    wb = Workbook()
    ws = wb.active
    ws.title = "弃电分析结果"

    # 写入表头
    ws.append(["电站名称", "弃电分析结果"])

    # 处理每个电站的数据
    for station_name, time_period_str in db_results:
        # 将字符串转换为时间列表
        time_periods = [tp.strip('"') for tp in time_period_str.split(',')]

        output = StringIO()
        with redirect_stdout(output):
            # 使用原有脚本逻辑进行分析
            analyze_time_periods(time_periods)

        # 写入Excel
        ws.append([station_name, output.getvalue()])
        output.close()

    # 保存Excel文件
    wb.save("power_station_discard_analysis.xlsx")
    print("分析结果已保存到 power_station_discard_analysis.xlsx")


if __name__ == "__main__":
    main()
